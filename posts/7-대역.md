# 대역

## 대역의 필요성

테스트를 작성하다 보면 외부 요인이 필요한 경우가 있다.

- 테스트 대상에서 File System 을 사용
- 테스트 대상에서 DB 호출
- 테스트 대상에서 외부 HTTP 서버 통신

이렇게 테스트 대상이 외부 요인에 의존하면 테스트를 작성하고 실행하기가 어렵고 결과를 예측할 수 없게 된다. (일시 장애, 데이터 등)

다음과 같이 실제 외부 서비스를 호출하는 테스트가 있다.

```java
public class AutoDebitRegisterTest {
    private AutoDebitRegister register;

    @BeforeEach
    void setUp() {
        CardNumberValidator validator = new CardNumberValidator();
        AutoDebitInfoRepository repository = new JpaAutoDebitInfoRepository();
        register = new AutoDebitRegister(validator, repository);
    }

    @Test
    void validCard() {
        // 업체에서 받은 테스트용 유효한 카드번호 사용
        AutoDebitReq req = new AutoDebitReq("user1", "1234123412341234");
        RegisterResult result = this.register.register(req);
        assertEquals(CardValidity.VALID, result.getValidity());
    }

    @Test
    void stolenCard() {
        // 업체에서 받은 테스트용 도난 카드번호 사용
        AutoDebitReq req = new AutoDebitReq("user1", "1002200230034004");
        RegisterResult result = this.register.register(req);
        assertEquals(CardValidity.STOLEN, result.getValidity());
    }
}
```

`CardNumberValidator` 클래스에는 외부 서비스와의 HTTP 통신을 하는 `validate` 메서드가 있고, `AutoDebitRegister` 의 `register` 메서드는 `validate` 를 호출한다.

만약 업체에서 제공한 카드의 유효기간이 한달밖에 남지 않았다면, 지금은 통과하는 테스트가 한달 뒤부터는 실패하게 되는 문제가 발생한다.

업체에서 제공한 도난 카드를 해당 업체에서 삭제할 경우에도 테스트는 실패한다.

이럴 때 대역을 써서 테스트를 진행할 수 있다.

고난이도 액션이 필요할 때 배우를 대신해서 연기하는 스턴트맨처럼 테스트에서는 외부 요인을 대신하는 대역이 외부 요인을 대신해서 테스트에 참여한다.

## 대역을 이용한 테스트

외부 서비스를 호출하는 `CardNumberValidator` 를 대신할 대역 클래스를 작성해보자.

```java
public class StubCardNumberValidator extends CardNumberValidator {
    private String stolenCardNumber;

    public void setStolenCardNumber(String stolenCardNumber) {
        this.stolenCardNumber = stolenCardNumber;
    }

    @Override
    public CardValidity validate(String cardNumber) {
        if (stolenCardNumber != null && stolenCardNumber.equals(cardNumber)) {
            return CardValidity.STOLEN;
        }
        return CardValidity.VALID;
    }
}
```

`StubCardNumberValidator` 는 실제 카드번호 검증 기능을 구현하지 않고 단순한 구현으로 실제 구현을 대체한다.

이를 적용하여 위 테스트 코드를 수정하면,

```java
public class AutoDebitRegisterStubTest {
    private AutoDebitRegister register;
    private StubCardNumberValidator stubValidator;

    @BeforeEach
    void setUp() {
        stubValidator = new StubCardNumberValidator();
        AutoDebitInfoRepository repository = new JpaAutoDebitInfoRepository();
        register = new AutoDebitRegister(stubValidator, repository);
    }

    @Test
    void stolenCard() {
        stubValidator.setStolenCardNumber("1111222233334444");

        AutoDebitReq req = new AutoDebitReq("user1", "1111222233334444");
        RegisterResult result = this.register.register(req);

        assertEquals(CardValidity.STOLEN, result.getValidity());
    }
}
```

`setUp` 메서드와 같이 `AutoDebitRegister` 는 실제 객체 대신에 `stubValidator` 를 사용하게 된다.

이렇게 되면 쉽게 `INVALID` 카드번호에 대한 테스트도 추가가 가능하다.

DB 연동 코드도 대역을 이용해서 `StubAutoDebitInfoRepository` 로 대체했다.

```java
public class MemoryAutoDebitInfoRepository implements AutoDebitInfoRepository {
    private Map<String, AutoDebitInfo> info = new HashMap<>();

    @Override
    public void save(AutoDebitInfo autoDebitInfo) {
        info.put(autoDebitInfo.getUserId, autoDebitInfo);
    }

    @Override
    public AutoDebitInfo findOne(String userId) {
        return info.get(userId);
    }
}
```

이렇게 DB 대신 Map 을 이용하여 메모리를 활용하면 DB와 같이 영속성을 제공하지는 않지만 충분히 테스트에 사용할 수 있을 만큼의 기능은 제공한다.

위 테스트 코드에 이를 적용하면 아래와 같은 테스트를 진행할 수 있게 된다.

```java
public class AutoDebitRegisterStubTest {
    private AutoDebitRegister register;
    private StubCardNumberValidator cardNumberValidator;
    private MemoryAutoDebitInfoRepository repository;

    @BeforeEach
    void setUp() {
        cardNumberValidator = new StubCardNumberValidator();
        repository = new MemoryAutoDebitInfoRepository();
        register = new AutoDebitRegister(cardNumberValidator, repository);
    }

    @Test
    void updateExistingUserInfo() {
        repository.save(new AutoDebitInfo("user1", "1111222233334444", LocalDateTime.now()));

        AutoDebitReq req = new AutoDebitReq("user1", "1234123412341234");
        RegisterResult result = this.register.register(req);

        AutoDebitInfo saved = repository.findOne("user1");
        assertEquals("1234123412341234", saved.getCardNumber());
    }

    @Test
    void registerNewUserInfo() {
        AutoDebitReq req = new AutoDebitReq("user1", "1357246813572468");
        RegisterResult result = this.register.register(req);

        AutoDebitInfo saved = repository.findOne("user1");
        assertEquals("1357246813572468", saved.getCardNumber());
    }
}
```

## 대역의 종류

- **Stub**: 구현을 단순한 것으로 대체한다. 테스트에 맞게 단순히 원하는 동작을 수행한다. 위의 `StubCardNumberValidator`가 stub 대역에 해당한다.
- **Fake**: 제품에는 적합하지 않지만, 실제 동작하는 구현을 제공한다. DB 대신에 메모리를 이용해서 구현한 `MemoryAutoDebitInfoRepository`가 fake 대역에 해당한다.
- **Spy**: 호출된 내역을 기록한다. 기록한 내용은 테스트 결과를 검증할 때 사용한다. **stub**이기도 하다.
- **Mock**: 기대한 대로 상호작용하는지 행위를 검증한다. 기대한 대로 동작하지 않으면 exception이 발생할 수 있다. **mock**객체는 **stub**이자 **spy**도 된다.  

